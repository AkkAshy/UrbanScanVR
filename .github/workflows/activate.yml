# Активация Unity Personal лицензии
# Использует puppeteer для автоматической активации .alf → .ulf
#
# После выполнения:
# 1. Скачай artifact unity-license-files
# 2. Скопируй содержимое .ulf в GitHub Secret UNITY_LICENSE

name: Activate Unity License

on:
  workflow_dispatch: {}

jobs:
  activate:
    name: Get Unity License
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Шаг 1: Генерация .alf на этой машине
      - name: Generate .alf file
        id: alf
        run: |
          docker run --rm -v "$PWD:/output" \
            unityci/editor:ubuntu-2022.3.45f1-windows-mono-3 \
            bash -c '
              unity-editor -batchmode -nographics -createManualActivationFile -logFile /dev/stdout -quit || true
              cp /*.alf /output/ 2>/dev/null || true
              cp /Unity*.alf /output/ 2>/dev/null || true
            '
          ALF_FILE=$(ls *.alf 2>/dev/null | head -1)
          echo "alf_file=$ALF_FILE" >> "$GITHUB_OUTPUT"
          echo "Found ALF: $ALF_FILE"
          cat "$ALF_FILE" | head -5

      # Шаг 2: Активация через unity-license-activate (puppeteer)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install unity-license-activate
        run: npm install -g unity-license-activate

      - name: Activate license via puppeteer
        run: |
          ALF_FILE="${{ steps.alf.outputs.alf_file }}"
          echo "Activating with ALF: $ALF_FILE"

          # unity-license-activate автоматизирует браузер и получает .ulf
          unity-license-activate \
            "${{ secrets.UNITY_EMAIL }}" \
            "${{ secrets.UNITY_PASSWORD }}" \
            "$ALF_FILE" \
            || true

          echo "=== Looking for .ulf files ==="
          find . -name "*.ulf" 2>/dev/null
          find /tmp -name "*.ulf" 2>/dev/null || true
          ls -la *.ulf 2>/dev/null || echo "No .ulf in current dir"

      # Шаг 3: Собрать все файлы
      - name: Collect license files
        run: |
          mkdir -p license-output
          cp *.ulf license-output/ 2>/dev/null || true
          cp *.alf license-output/ 2>/dev/null || true
          find /tmp -name "*.ulf" -exec cp {} license-output/ \; 2>/dev/null || true
          find . -name "*.ulf" -exec cp {} license-output/ \; 2>/dev/null || true
          echo "=== Collected ==="
          ls -la license-output/

      - name: Upload license files
        uses: actions/upload-artifact@v4
        with:
          name: unity-license-files
          path: license-output/
          retention-days: 1
          if-no-files-found: warn
